{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Transform": "AWS::Serverless-2016-10-31",
  "Description": "Creates the regional lambda function and connects it to the Proxylity UDP Destination.",
  "Parameters": {
    "DestinationId": {
      "Description": "The Proxylity UDP Gateway Destination ID created in the global stack.",
      "Type": "String"
    }
  },
  "Mappings": {
    "ProxylityConfig": {
      "Fn::Transform": {
        "Name": "AWS::Include",
        "Parameters": {
          "Location": {
            "Fn::Sub": "s3://proxylity-config-${AWS::Region}/${AWS::AccountId}/customer-config.json"
          }
        }
      }
    }
  },
  "Resources": {
    "PacketCounterLambda": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "FunctionName": "packet-counter",
        "Policies": [
          "AWSLambdaBasicExecutionRole"
        ],
        "Handler": "index.handler",
        "MemorySize": 1024,
        "Timeout": 10,
        "Runtime": "nodejs22.x",
        "InlineCode": {
          "Fn::Join": [
            "\n",
            [
              "exports.handler = async (inbound_packets) => {",
              "  const counts_by_src = inbound_packets.Messages.reduce((acc, obj) => {",
              "    const src = obj.Remote.IpAddress;",
              "    acc[src] = (acc[src] || 0) + 1;",
              "    return acc;",
              "  }, {})",
              "  function get_and_clear_count_in_b64(map, key) {",
              "    const value = map[key];",
              "    if (value == null) return null;",
              "    map[key] = null;",
              { "Fn::Sub": "    return btoa(value.toString() + ' ${AWS::Region}\\n');" },
              "  }",
              "  const outbound_packets = inbound_packets.Messages.map(function (p) {",
              "    const d = get_and_clear_count_in_b64(counts_by_src, p.Remote.IpAddress);",
              "    if (d == null) return null;",
              "    return {",
              "      GeneratedAt: new Date().toISOString(),",
              "      Tag: p.Tag, Data: d  ",
              "    }",
              "  });",
              "  return { Replies: outbound_packets };",
              "};"
            ]
          ]
        }
      }
    },
    "DestinationArn": {
      "Type": "Custom::ProxylityUdpGatewayDestinationArn",
      "Properties": {
        "ServiceToken": {
          "Fn::FindInMap": [
            "ProxylityConfig",
            {
              "Ref": "AWS::Region"
            },
            "ServiceToken"
          ]
        },
        "ApiKey": {
          "Fn::FindInMap": [
            "ProxylityConfig",
            "Account",
            "ApiKey"
          ]
        },
        "Destination": {
          "Ref": "DestinationId"
        },
        "IngressRegionKey": {
          "Ref": "AWS::Region"
        },
        "Arn": {
          "Fn::GetAtt": [ "PacketCounterLambda", "Arn" ]
        }
      }
    }
  },
  "Outputs": {
    "PacketCounterArn": {
      "Value": {
        "Fn::GetAtt": [ "PacketCounterLambda", "Arn" ]
      }
    }
  }
}